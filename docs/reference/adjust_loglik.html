<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Loglikelihood adjustment using the sandwich estimator — adjust_loglik • chandwich</title><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Loglikelihood adjustment using the sandwich estimator — adjust_loglik"><meta name="description" content="Performs adjustments of a user-supplied independence loglikelihood for the
presence of cluster dependence, following Chandler and Bate (2007).
The user provides a function that returns a vector of observation-specific
loglikelihood contributions and a vector that indicates cluster membership.
The loglikelihood of a sub-model can be adjusted by fixing a set of
parameters at particular values."><meta property="og:description" content="Performs adjustments of a user-supplied independence loglikelihood for the
presence of cluster dependence, following Chandler and Bate (2007).
The user provides a function that returns a vector of observation-specific
loglikelihood contributions and a vector that indicates cluster membership.
The loglikelihood of a sub-model can be adjusted by fixing a set of
parameters at particular values."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chandwich</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/chandwich-vignette.html">Introducing chandwich: Chandler-Bate Sandwich Loglikelihood Adjustment</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/paulnorthrop/chandwich/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Loglikelihood adjustment using the sandwich estimator</h1>
      <small class="dont-index">Source: <a href="https://github.com/paulnorthrop/chandwich/blob/HEAD/R/adjust_loglik.R"><code>R/adjust_loglik.R</code></a></small>
      <div class="d-none name"><code>adjust_loglik.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Performs adjustments of a user-supplied independence loglikelihood for the
presence of cluster dependence, following Chandler and Bate (2007).
The user provides a function that returns a vector of observation-specific
loglikelihood contributions and a vector that indicates cluster membership.
The loglikelihood of a sub-model can be adjusted by fixing a set of
parameters at particular values.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">adjust_loglik</span><span class="op">(</span></span>
<span>  loglik <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  cluster <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  p <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  init <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  par_names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fixed_pars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fixed_at <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  larger <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  alg_deriv <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  alg_hess <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  mle <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  H <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  V <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-loglik">loglik<a class="anchor" aria-label="anchor" href="#arg-loglik"></a></dt>
<dd><p>A named function.  Returns a vector of the
loglikelihood contributions of individual observations.  The first
argument must be the vector of model parameter(s). If any of the model
parameters are out-of-bounds then <code>loglik</code> should return either
<code>-Inf</code> or a vector with at least one element equal to <code>-Inf</code>.
The number of parameters in the <strong>full</strong> model must be specified
using (at least) one of the arguments <code>p</code>, <code>init</code> or
<code>par_names</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Further arguments to be passed either to <code>loglik</code>
(and to <code>alg_deriv</code> and <code>alg_hess</code> if these are supplied) or
to <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>.  The latter may include <code>gr</code>,
<code>method</code>, <code>lower</code>, <code>upper</code> or <code>control</code>.
In the call to <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>, <code>hessian = TRUE</code>
will be used regardless of any value supplied.
The function <code>loglik</code> must <em>not</em> have arguments with names
that match any of these arguments to <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>.</p></dd>


<dt id="arg-cluster">cluster<a class="anchor" aria-label="anchor" href="#arg-cluster"></a></dt>
<dd><p>A vector or factor indicating from which cluster the
respective loglikelihood contributions from <code>loglik</code> originate.
Must have the same length as the vector returned by <code>loglik</code>.
If <code>cluster</code> is not supplied then it is set inside
<code>adjust_loglik</code> under the assumption that each observation forms
its own cluster.</p></dd>


<dt id="arg-p">p<a class="anchor" aria-label="anchor" href="#arg-p"></a></dt>
<dd><p>A numeric scalar.  The dimension of the <strong>full</strong> parameter
vector, i.e. the number of parameters in the full model.  Must be
consistent with the lengths of <code>init</code> and <code>par_names</code>,
if these are also supplied.</p></dd>


<dt id="arg-init">init<a class="anchor" aria-label="anchor" href="#arg-init"></a></dt>
<dd><p>A numeric vector of initial values.  Must have length equal
to the number of parameters in the <strong>full</strong> model.  If <code>init</code>
is supplied then <code>p</code> is set to <code>length(init)</code>, provided that
this is consistent with the the value given by <code>p</code> or implied
by <code>length(par_names)</code>.
If <code>fixed_pars</code> is not <code>NULL</code> then <code>init[-fixed_pars]</code>
is used in the search for the MLE.
If <code>init</code> is not supplied then <code>rep(0.1, p)</code> is used.</p></dd>


<dt id="arg-par-names">par_names<a class="anchor" aria-label="anchor" href="#arg-par-names"></a></dt>
<dd><p>A character vector.  Names of the <code>p</code> parameters
in the <strong>full</strong> model.  Must be consistent with the lengths of
<code>init</code> and <code>p</code>, if these are also supplied.</p></dd>


<dt id="arg-fixed-pars">fixed_pars<a class="anchor" aria-label="anchor" href="#arg-fixed-pars"></a></dt>
<dd><p>A vector specifying which parameters are to be restricted
to be equal to the value(s) in <code>fixed_at</code>.  Can be either a numeric
vector, specifying indices of the components of the <strong>full</strong> parameter
vector, or a character vector of parameter names, which must be a subset
of those supplied in <code>par_names</code> or stored in the object
<code>larger</code>.</p></dd>


<dt id="arg-fixed-at">fixed_at<a class="anchor" aria-label="anchor" href="#arg-fixed-at"></a></dt>
<dd><p>A numeric vector of length 1 or <code>length(fixed_pars)</code>.
If <code>length(fixed_at) = 1</code> then the components <code>fixed_pars</code>
of the parameter vector are all fixed at <code>fixed_at</code>.
If <code>length(fixed_at) = length(fixed_pars)</code> then the component
<code>fixed_pars[i]</code> is fixed at <code>fixed_at[i]</code> for each <code>i</code>.</p></dd>


<dt id="arg-name">name<a class="anchor" aria-label="anchor" href="#arg-name"></a></dt>
<dd><p>A character scalar.  A name for the model that gives rise
to <code>loglik</code>.  If this is not supplied then the name in
<code>larger</code> is used, if this has been supplied, and the name of
the function <code>loglik</code> otherwise.</p></dd>


<dt id="arg-larger">larger<a class="anchor" aria-label="anchor" href="#arg-larger"></a></dt>
<dd><p>Only relevant if <code>fixed_pars</code> is not <code>NULL</code>.
  If <code>larger</code> is supplied but <code>fixed_pars</code> is not then an error
  will result.  if <code>larger</code> is supplied then information about the
  model in <code>larger</code>, e.g. about <code>p</code> and <code>par_names</code> will
  override any attempt to set these arguments in the call to
  <code>adjust_loglik</code>.</p>
<p>An object of class <code>"chandwich"</code> returned by <code>adjust_loglik</code>,
  corresponding to a model in which the smaller model implied by
  <code>fixed_pars</code> is nested.  If <code>larger</code> is supplied then
  all the arguments to <code>adjust_loglik</code> apart from
  <code>fixed_pars</code> and <code>fixed_at</code> are extracted from <code>larger</code>.
  If <code>init</code> is not supplied in the current call to
  <code>adjust_loglik</code> then <code>init</code> is set to
  <code>attr(larger, "MLE")</code>, with the elements in <code>fixed_pars</code>
  set to <code>fixed_at</code>.</p></dd>


<dt id="arg-alg-deriv">alg_deriv<a class="anchor" aria-label="anchor" href="#arg-alg-deriv"></a></dt>
<dd><p>A function with the vector of model parameter(s) as its
first argument.  Returns a <code>length(cluster)</code> by <code>p</code> numeric
matrix. Column i contains the derivatives of each of the loglikelihood
contributions in <code>loglik</code> with respect to model parameter i.</p></dd>


<dt id="arg-alg-hess">alg_hess<a class="anchor" aria-label="anchor" href="#arg-alg-hess"></a></dt>
<dd><p>A function with the vector of model parameter(s) as its
  first argument.  Returns a <code>p</code> by <code>p</code> numeric matrix equal to
  the Hessian of <code>loglik</code>, i.e. the matrix of second derivatives of
  the function <code>loglik</code>.</p>
<p>Supplying both <code>V</code> and <code>alg_deriv</code> or both <code>H</code> and
  <code>alg_hess</code> will produce an error.</p></dd>


<dt id="arg-mle">mle<a class="anchor" aria-label="anchor" href="#arg-mle"></a></dt>
<dd><p>A numeric vector.  Can only be used if <code>fixed_pars = NULL</code>.
Provides the maximum likelihood estimate of the model parameters,
that is, the value of the parameter vector
at which the independence loglikelihood <code>loglik</code> is maximized.
Must have length equal to the number of parameters in the
<strong>full</strong> model.  If <code>mle</code> is supplied then <code>p</code> is set
to <code>length(mle)</code>, provided that this is consistent with the the
value given by <code>p</code> or implied by <code>length(par_names)</code>.
If <code>mle</code> is supplied then it overrides <code>init</code>.</p></dd>


<dt id="arg-h-v">H, V<a class="anchor" aria-label="anchor" href="#arg-h-v"></a></dt>
<dd><p>p by p numeric matrices.  Only used if <code>mle</code> is supplied.
  Provide estimates of the Hessian of the
  independence loglikelihood (H) and the variance of the vector
  of cluster-specific contributions to the score vector (first
  derivatives with respect to the parameters) of the independence
  loglikelihood, each evaluated at the MLE <code>mle</code>.  See the
  <em>Introducing chandwich</em> vignette and/or Chandler and Bate (2007).</p>
<p>Supplying both <code>V</code> and <code>alg_deriv</code> or both <code>H</code> and
  <code>alg_hess</code> will produce an error.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A function of class <code>"chandwich"</code> to evaluate an adjusted
  loglikelihood, or the independence loglikelihood, at one or more sets
  of model parameters, with arguments</p>
<dl><dt>x</dt>
<dd><p>A numeric vector or matrix giving values of the <code>p_current</code>
    (see below) parameters in the model to which the returned adjusted
    loglikelihood applies.
    If <code>p_current = 1</code> this may be a numeric vector or a matrix
    with 1 column.
    If <code>p_current &gt; 1</code> this may be a numeric vector of length <code>p</code>
    (one set of model parameters) or a numeric matrix with <code>p</code>
    columns (<code>nrow(x)</code> sets of model parameters), one set in each row
    of <code>x</code>.</p></dd>

  <dt>type</dt>
<dd><p>A character scalar.  The type of adjustment to use.
    One of <code>"vertical"</code>, <code>"cholesky"</code>, <code>"spectral"</code> or
    <code>"none"</code>.</p></dd>
</dl><p>The latter results in the evaluation of the
    (unadjusted) independence loglikelihood.
  The function has (additional) attributes</p>
<dl><dt>p_full, p_current</dt>
<dd><p>The number of parameters in the full model and
    current models, respectively.</p></dd>

  <dt>free_pars</dt>
<dd><p>A numeric vector giving the indices of the free
    parameters in the current model, with names inferred from
    <code>par_names</code> if this was supplied.</p></dd>

  <dt>MLE, res_MLE</dt>
<dd><p>Numeric vectors, with names inferred from
    <code>par_names</code> if this was supplied.  Maximum likelihood estimates
    of free parameters under the current model (<code>mle</code>) and all
    parameters in the full model, including any parameters with fixed
    values (<code>res_MLE</code>).</p></dd>

  <dt>SE, adjSE</dt>
<dd><p>The unadjusted and adjusted estimated standard errors,
    of the free parameters, respectively.</p></dd>

  <dt>VC, adjVC</dt>
<dd><p>The unadjusted and adjusted estimated
    variance-covariance matrix of the free parameters, respectively.</p></dd>

  <dt>HI, HA</dt>
<dd><p>The Hessians of the independence and adjusted loglikelihood,
    respectively.</p></dd>

  <dt>C_cholesky, C_spectral</dt>
<dd><p>The matrix C in equation (14) of Chandler and
    Bate (2007), calculated using Cholesky decomposition and spectral
    decomposition, respectively.</p></dd>

  <dt>full_par_names, par_names</dt>
<dd><p>The names of the parameters in the full
    and current models, respectively, if these were supplied in
    this call or a previous call.</p></dd>

  <dt>max_loglik</dt>
<dd><p>The common maximised value of the independence and
    adjusted loglikelihoods.</p></dd>

  <dt>loglik, cluster</dt>
<dd><p>The arguments <code>loglik</code> and <code>cluster</code>
    supplied in this call, or a previous call.</p></dd>

  <dt>loglik_args</dt>
<dd><p>A list containing the further arguments passed to
    <code>loglik</code> via ... in this call, or a previous call.</p></dd>

  <dt>loglikVecMLE</dt>
<dd><p>a vector containing the contributions of individual
    observations to the independence log-likelihood evaluated at the MLE.</p></dd>

  <dt>name</dt>
<dd><p>The argument <code>name</code>, or the name of the function
    <code>loglik</code> if <code>name</code> isn't supplied.</p></dd>

  <dt>nobs</dt>
<dd><p>The number of observations.</p></dd>

  <dt>call</dt>
<dd><p>The call to <code>adjust_loglik</code>.</p></dd>

</dl><p>If <code>fixed_pars</code> is not <code>NULL</code> then there are further attributes</p>
<dl><dt>fixed_pars</dt>
<dd><p>The argument <code>fixed_pars</code>, with names inferred from
    <code>par_names</code> if this was supplied.</p></dd>

  <dt>fixed_at</dt>
<dd><p>The argument <code>fixed_at</code>, with names inferred from
    <code>par_names</code> if this was supplied.</p></dd>

</dl><p>If <code>alg_deriv</code> and/or <code>alg_hess</code> were supplied then these are
  returned as further attributes.</p>
<p>To view an individual attribute called <code>att_name</code> use
  <code>attr(x, "att_name")</code> or <code>attributes(x)$att_name</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Three adjustments to the independence loglikelihood described in
  Chandler and Bate (2007) are available.  The vertical adjustment is
  described in Section 6 and two horizontal adjustments are described
  in Sections 3.2 to 3.4.  See the descriptions of <code>type</code> and, for the
  horizontal adjustments, the descriptions of <code>C_cholesky</code> and
  <code>C_spectral</code>, in <strong>Value</strong>.</p>
<p>The adjustments involve first and second derivatives of the loglikelihood
  with respect to the model parameters.  These are estimated using
  <code><a href="https://rdrr.io/pkg/numDeriv/man/jacobian.html" class="external-link">jacobian</a></code> and <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optimHess</a></code>
  unless <code>alg_deriv</code> and/or <code>alg_hess</code> are supplied.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Chandler, R. E. and Bate, S. (2007). Inference for clustered
  data using the independence loglikelihood. <em>Biometrika</em>,
  <strong>94</strong>(1), 167-183. <a href="https://doi.org/10.1093/biomet/asm015" class="external-link">doi:10.1093/biomet/asm015</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="summary.chandwich.html">summary.chandwich</a></code> for maximum likelihood estimates
  and unadjusted and adjusted standard errors.</p>
<p><code><a href="plot.chandwich.html">plot.chandwich</a></code> for plots of one-dimensional adjusted
  loglikelihoods.</p>
<p><code><a href="confint.chandwich.html">confint.chandwich</a></code>, <code><a href="anova.chandwich.html">anova.chandwich</a></code>,
  <code><a href="coef.chandwich.html">coef.chandwich</a></code>, <code><a href="vcov.chandwich.html">vcov.chandwich</a></code>
  and <code><a href="logLik.chandwich.html">logLik.chandwich</a></code> for other <code>chandwich</code> methods.</p>
<p><code><a href="conf_intervals.html">conf_intervals</a></code> for confidence intervals for
  individual parameters.</p>
<p><code><a href="conf_region.html">conf_region</a></code> for a confidence region for
  a pair of parameters.</p>
<p><code><a href="compare_models.html">compare_models</a></code> to compare nested models using an
  (adjusted) likelihood ratio test.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># ------------------------- Binomial model, rats data ----------------------</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Contributions to the independence loglikelihood</span></span></span>
<span class="r-in"><span><span class="va">binom_loglik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prob</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="va">prob</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">||</span> <span class="va">prob</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="st">"y"</span><span class="op">]</span>, <span class="va">data</span><span class="op">[</span>, <span class="st">"n"</span><span class="op">]</span>, <span class="va">prob</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">rat_res</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span>loglik <span class="op">=</span> <span class="va">binom_loglik</span>, data <span class="op">=</span> <span class="va">rats</span>, par_names <span class="op">=</span> <span class="st">"p"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the loglikelihoods</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rat_res</span>, type <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, legend_pos <span class="op">=</span> <span class="st">"bottom"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="adjust_loglik-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># MLE, SEs and adjusted SEs</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rat_res</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      MLE       SE adj. SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> p 0.1535 0.008645 0.01305</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># -------------------------- GEV model, owtemps data -----------------------</span></span></span>
<span class="r-in"><span><span class="co"># ------------ following Section 5.2 of Chandler and Bate (2007) -----------</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Contributions to the independence loglikelihood</span></span></span>
<span class="r-in"><span><span class="va">gev_loglik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">o_pars</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">w_pars</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">o_pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">w_pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">o_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="st">"Oxford"</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">w_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="st">"Worthing"</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">check</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">o_pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">o_data</span> <span class="op">-</span> <span class="va">o_pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">o_pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">check</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">check</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">w_pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">w_data</span> <span class="op">-</span> <span class="va">w_pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">w_pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">check</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">o_loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="log_gev.html">log_gev</a></span><span class="op">(</span><span class="va">o_data</span>, <span class="va">o_pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">o_pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">o_pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">w_loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="log_gev.html">log_gev</a></span><span class="op">(</span><span class="va">w_data</span>, <span class="va">w_pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">w_pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">w_pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">o_loglik</span> <span class="op">+</span> <span class="va">w_loglik</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Initial estimates (method of moments for the Gumbel case)</span></span></span>
<span class="r-in"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">6</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">owtemps</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">pi</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">owtemps</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.57722</span> <span class="op">*</span> <span class="va">sigma</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Loglikelihood adjustment for the full model</span></span></span>
<span class="r-in"><span><span class="va">par_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu[0]"</span>, <span class="st">"mu[1]"</span>, <span class="st">"sigma[0]"</span>, <span class="st">"sigma[1]"</span>, <span class="st">"xi[0]"</span>, <span class="st">"xi[1]"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">large</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span><span class="va">gev_loglik</span>, data <span class="op">=</span> <span class="va">owtemps</span>, init <span class="op">=</span> <span class="va">init</span>,</span></span>
<span class="r-in"><span>                       par_names <span class="op">=</span> <span class="va">par_names</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Rows 1, 3 and 4 of Table 2 of Chandler and Bate (2007)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">large</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           mu[0]  mu[1] sigma[0] sigma[1]    xi[0]    xi[1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MLE     81.1700 2.6680   3.7290   0.5312 -0.19890 -0.08835</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SE       0.3282 0.3282   0.2293   0.2293  0.04937  0.04937</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> adj. SE  0.4036 0.2128   0.2426   0.1911  0.03943  0.03625</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Loglikelihood adjustment of some smaller models: xi[1] = 0 etc</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Starting from a larger model</span></span></span>
<span class="r-in"><span><span class="va">medium</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span>larger <span class="op">=</span> <span class="va">large</span>, fixed_pars <span class="op">=</span> <span class="st">"xi[1]"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">small</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span>larger <span class="op">=</span> <span class="va">large</span>, fixed_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigma[1]"</span>, <span class="st">"xi[1]"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">small</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span>larger <span class="op">=</span> <span class="va">medium</span>, fixed_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigma[1]"</span>, <span class="st">"xi[1]"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Starting from scratch</span></span></span>
<span class="r-in"><span><span class="va">medium</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span><span class="va">gev_loglik</span>, data <span class="op">=</span> <span class="va">owtemps</span>, init <span class="op">=</span> <span class="va">init</span>,</span></span>
<span class="r-in"><span>          par_names <span class="op">=</span> <span class="va">par_names</span>, fixed_pars <span class="op">=</span> <span class="st">"xi[1]"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">small</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span><span class="va">gev_loglik</span>, data <span class="op">=</span> <span class="va">owtemps</span>, init <span class="op">=</span> <span class="va">init</span>,</span></span>
<span class="r-in"><span>         par_names <span class="op">=</span> <span class="va">par_names</span>, fixed_pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sigma[1]"</span>, <span class="st">"xi[1]"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># --------- Misspecified Poisson model for negative binomial data ----------</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ... following Section 5.1 of the "Object-Oriented Computation of Sandwich</span></span></span>
<span class="r-in"><span><span class="co"># Estimators" vignette of the sandwich package</span></span></span>
<span class="r-in"><span><span class="co"># https://cran.r-project.org/web/packages/sandwich/vignettes/sandwich-OOP.pdf</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">250</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="fl">250</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Fit misspecified Poisson model</span></span></span>
<span class="r-in"><span><span class="va">fm_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, family <span class="op">=</span> <span class="va">poisson</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm_pois</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                Estimate Std. Error   z value      Pr(&gt;|z|)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)  1.06326821 0.04135723 25.709367 9.184267e-146</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> x            0.99607219 0.05353446 18.606186  2.862861e-77</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> I(x^2)      -0.04912373 0.02314608 -2.122335  3.380961e-02</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Contributions to the independence loglikelihood</span></span></span>
<span class="r-in"><span><span class="va">pois_glm_loglik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">log_mu</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">^</span> <span class="fl">2</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">y</span>, lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_mu</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"gamma"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">pois_quad</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span><span class="va">pois_glm_loglik</span>, y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, par_names <span class="op">=</span> <span class="va">pars</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pois_quad</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            MLE      SE adj. SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> alpha  1.06300 0.04136 0.08378</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> beta   0.99610 0.05354 0.10520</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gamma -0.04913 0.02315 0.03628</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Providing algebraic derivatives and Hessian</span></span></span>
<span class="r-in"><span><span class="va">pois_alg_deriv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">mu</span>, <span class="va">x</span> <span class="op">*</span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span>, <span class="va">x</span> <span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">pois_alg_hess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="va">pars</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">alg_hess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">alg_hess</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">alg_hess</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">alg_hess</span><span class="op">[</span><span class="fl">3</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">4</span> <span class="op">*</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">alg_hess</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="va">pois_quad</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span><span class="va">pois_glm_loglik</span>, y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, p <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>                           alg_deriv <span class="op">=</span> <span class="va">pois_alg_deriv</span>, alg_hess <span class="op">=</span> <span class="va">pois_alg_hess</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pois_quad</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        MLE      SE adj. SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1  1.06300 0.04136 0.08378</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2  0.99610 0.05354 0.10520</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 -0.04913 0.02315 0.03628</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">got_sandwich</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"sandwich"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="va">got_sandwich</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># Providing MLE, H and V</span></span></span>
<span class="r-in"><span>  <span class="co"># H and V calculated using bread() and meat() from sandwich package</span></span></span>
<span class="r-in"><span>  <span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/nobs.html" class="external-link">nobs</a></span><span class="op">(</span><span class="va">fm_pois</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">pois_quad</span> <span class="op">&lt;-</span> <span class="fu">adjust_loglik</span><span class="op">(</span><span class="va">pois_glm_loglik</span>, y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>, p <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>                             mle <span class="op">=</span> <span class="va">fm_pois</span><span class="op">$</span><span class="va">coefficients</span>,</span></span>
<span class="r-in"><span>                             H <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/bread.html" class="external-link">bread</a></span><span class="op">(</span><span class="va">fm_pois</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_obs</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                             V <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/meat.html" class="external-link">meat</a></span><span class="op">(</span><span class="va">fm_pois</span><span class="op">)</span> <span class="op">*</span> <span class="va">n_obs</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul J. Northrop, Richard E. Chandler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

